<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{description}" />
    <meta name="keywords" content="{keywords}" />
    <meta name="author" content="{author}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/v/bs5/dt-2.0.8/datatables.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.28.0/themes/prism.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css" />
    <link rel="stylesheet" href="{theme://resources/local-notion/css/common.css}" />
    <link rel="stylesheet" href="{theme://resources/local-notion/css/{render_mode}.css}" />
    <link rel="stylesheet" href="{theme://resources/css/cms.css}" />
    <link rel="shortcut icon" href="{site_icon_url}" type="image/x-icon" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{theme://resources/js/cms_pre.js}"></script>
    <title>{title}</title>
    {include://google_tag.inc}
</head>
<body class="ln-page-{style}">
    <div id="preloader"><div id="preloader_status"></div></div>
    {include://page_navbar.inc}
    {include://page_header.inc}
    <main>
        {page_content}
    </main>
    {include://page_footer.inc}
    <script src="{theme://resources/js/feather.min.js}"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="{theme://resources/js/typed.umd.js}"></script>
    <script src="{theme://resources/js/imagesloaded.pkgd.min.js}"></script>
    <script src="{theme://resources/js/isotope.pkgd.min.js}"></script>
    <script src="{theme://resources/js/BigPicture.min.js}"></script>
    <script src="{theme://resources/local-notion/js/toc.js}"></script>
    <script src="{theme://resources/local-notion/js/ln.js}"></script>
    <!--script src="{theme://resources/js/cms_post.js}"></script-->
<script>
    function PageLoader_Init() {
        // Inject preloader into the body if necessary
        //$("body").prepend('<div id="preloader"><div id="preloader_status"></div></div>');

        var isBot = /bot|googlebot|bingbot|baiduspider|yandexbot|slurp|duckduckbot|applebot|sogou|seznambot|naverbot|exabot|rogerbot|ahrefsbot/i.test(navigator.userAgent);

        var preloader = document.getElementById('preloader');

        if (isBot || !preloader) {
            preloader?.remove();  // Remove if bot or preloader is not found
            return;
        }

        // Select status element as a child of preloader
        var status = preloader.querySelector('#preloader_status');
        if (!status) {
            preloader.remove();  // Clean up if no status found
            return;
        }

        preloader.style.opacity = 1;
        status.style.opacity = 1;

        window.addEventListener('load', function () {
            let fadeOutAmount = 0.1;

            // Fade out status element
            (function fadeStatus() {
                status.style.opacity -= fadeOutAmount;
                if (status.style.opacity <= 0) {
                    status.style.display = "none";
                } else {
                    setTimeout(fadeStatus, 50);
                }
            })();

            // After 400ms, start fading out the preloader
            setTimeout(() => {
                (function fadePreloader() {
                    preloader.style.opacity -= fadeOutAmount;
                    if (preloader.style.opacity <= 0) {
                        preloader.style.display = "none";
                        preloader.remove();  // Remove preloader from the DOM
                    } else {
                        setTimeout(fadePreloader, 40);
                    }
                })();
            }, 400);
        });
    }

    function SetActiveNavbarItems() {
        // Define the classes to add/remove
        const activeClasses = ['active', 'text-bg-primary'];

        // Get current URL path, query string, and hash
        const currentUrl = window.location.pathname + window.location.search + window.location.hash;

        // Get all nav-links within the navbar, including dropdown items
        const navLinks = document.querySelectorAll('.navbar-nav .nav-link, .navbar-nav .dropdown-item');

        // Iterate over navLinks
        for (let i = 0; i < navLinks.length; i++) {
            const link = navLinks[i];
            const href = link.getAttribute('href');

            // Ignore links with href="#" or empty href
            if (!href || href.includes('#') || href === '') {
                continue;
            }

            const linkUrl = new URL(link.href, window.location.origin);

            // Remove the active classes from all links
            link.classList.remove(...activeClasses);

            // Rule A: Exact URL match or homepage link when on the root
            if (
                (linkUrl.pathname === window.location.pathname) ||
                (linkUrl.pathname === '/' && window.location.pathname === '/')
            ) {
                link.classList.add(...activeClasses);
            }

            // Rule B: Current URL is a sub-folder of the link URL, but not the root
            else if (window.location.pathname.startsWith(linkUrl.pathname) && linkUrl.pathname !== '/') {
                link.classList.add(...activeClasses);
            }
        }
    }

    function InitializeNestedDropdowns() {
        const nestedDropdowns = document.querySelectorAll('.dropdown-menu .dropdown');

        for (let i = 0; i < nestedDropdowns.length; i++) {
            const submenu = nestedDropdowns[i];
            const parentLink = submenu.querySelector('.dropdown-toggle');

            parentLink.addEventListener('click', function (event) {
                event.preventDefault();
                event.stopPropagation(); // Prevent Bootstrap's logic from interfering with nested dropdowns
            });
        }
    }

    function InitializeSectionSeparatorShapes() {
        function GetEffectiveBackgroundColor(element) {
            let color = window.getComputedStyle(element).backgroundColor;

            // Loop through parent elements to find the first non-transparent, non-translucent color
            while (IsTranslucent(color) && element.parentElement) {
                element = element.parentElement;
                color = window.getComputedStyle(element).backgroundColor;
            }

            return color;
        }

        function IsTranslucent(color) {
            const rgbaMatch = color.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+),?\s*([\d.]+)?\)$/);
            if (rgbaMatch && rgbaMatch[4] !== undefined) {
                const alpha = parseFloat(rgbaMatch[4]);
                return alpha < 1 && alpha >= 0; // Include fully opaque and translucent colors
            }
            return false;
        }

        function IsVisible(element) {
            const nonVisualTags = ['script', 'style', 'meta', 'link'];
            return !nonVisualTags.includes(element.tagName.toLowerCase()) &&
                getComputedStyle(element).display !== 'none' &&
                getComputedStyle(element).visibility !== 'hidden';
        }

        function GetNextLogicalSibling(element) {
            // If the element has a next sibling, return it
            if (element.nextElementSibling) {
                return element.nextElementSibling;
            }

            // If there's no next sibling, move up to the parent and try to get the parent's next sibling
            let parent = element.parentElement;
            while (parent) {
                if (parent.nextElementSibling) {
                    return parent.nextElementSibling;
                }
                parent = parent.parentElement; // Keep moving up the hierarchy
            }

            // If no logical sibling is found, return null
            return null;
        }

        function GetNextVisibleLogicalSibling(element) {
            let nextElement = GetNextLogicalSibling(element);
            while (nextElement && !IsVisible(nextElement)) {
                nextElement = GetNextLogicalSibling(nextElement);
            }
            return nextElement;
        }

        // Process each shape
        document.querySelectorAll('.shape').forEach(function (shape) {
            const shapeContainerDiv = shape.closest('.shape-container'); // Get the shape container
            if (!shapeContainerDiv)
                return; // some other shape (not a page separating shape)
            let currentContent = shapeContainerDiv.parentElement;

            let nextContent = GetNextVisibleLogicalSibling(currentContent); // Get the next sibling
            if (nextContent && nextContent.tagName.toLowerCase() === 'main') {
                // If the nextContent is a <main>, get its first child
                nextContent = nextContent.firstElementChild;
                if (nextContent && !IsVisible(nextContent))
                    nextContent = GetNextVisibleLogicalSibling(nextContent);
            }
            if (nextContent) {
                const sectionColor = GetEffectiveBackgroundColor(nextContent); // Get effective background color
                const svgPath = shape.querySelector('svg path'); // Find the path inside the SVG
                if (svgPath) {
                    // Apply the computed background color as fill, including any alpha
                    svgPath.setAttribute('fill', sectionColor); // Set the fill attribute to the background color
                }

                // Adjust the shape bottom so it sits at end of currentContent
                const paddingBottom = window.getComputedStyle(currentContent).paddingBottom;
                shape.style.bottom = `-${paddingBottom}`;
            }
        });
    }

    function InitializeTypedText() {
        const toggles = document.querySelectorAll('[data-typed]');
        toggles.forEach((toggle) => {
            const elementOptions = toggle.dataset.typed ? JSON.parse(toggle.dataset.typed) : {};

            const defaultOptions = {
                typeSpeed: 40,
                backSpeed: 40,
                backDelay: 1000,
                loop: true,
            };

            const options = {
                ...defaultOptions,
                ...elementOptions,
            };

            new Typed(toggle, options);
        });

    }

    function InitializeAnimateOnScroll() {
        const options = {
            duration: 700,
            easing: 'ease-out-quad',
            once: true,
            delay: 10,
            startEvent: 'load',
        };
        AOS.init(options);
        window.AOS = AOS; // Make available globally
    }

    function InitializeGalleries() {
        const toggles = document.querySelectorAll('[data-isotope]');
        const filters = document.querySelectorAll('[data-filter]');

        toggles.forEach(function (toggle) {
            imagesLoaded(toggle, function () {
                const options = JSON.parse(toggle.dataset.isotope);

                new Isotope(toggle, options);
            });
        });

        filters.forEach(function (filter) {
            filter.addEventListener('click', function (e) {
                e.preventDefault();

                const cat = filter.dataset.filter;
                const target = filter.dataset.bsTarget;
                const instance = Isotope.data(target);

                instance.arrange({
                    filter: cat,
                });
            });
        });

        // Make available globally
        window.Isotope = Isotope;
        window.imagesLoaded = imagesLoaded;
    }

    function InitializeBigPictures() {
        const toggles = document.querySelectorAll('[data-bigpicture]');

        toggles.forEach(function (toggle) {
            toggle.addEventListener('click', function (e) {
                e.preventDefault();

                const elementOptions = JSON.parse(toggle.dataset.bigpicture);

                const defaultOptions = {
                    el: toggle,
                    noLoader: true,
                };

                const options = {
                    ...defaultOptions,
                    ...elementOptions,
                };

                BigPicture(options);
            });
        });

        // Make available globally
        window.BigPicture = BigPicture;
    }

    /************************************************ MAIN **********************************************************************/

    PageLoader_Init();
    SetActiveNavbarItems();
    InitializeNestedDropdowns();
    InitializeSectionSeparatorShapes();
    InitializeTypedText();
    InitializeAnimateOnScroll();
    InitializeGalleries();
    InitializeBigPictures();

</script>
    <script async src="https://cdn.datatables.net/v/bs5/dt-2.0.8/datatables.min.js"></script>
    <script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script async src="https://cdn.jsdelivr.net/npm/prismjs@1.28.0/components/prism-core.min.js"></script>
    <script async src="https://cdn.jsdelivr.net/npm/prismjs@1.28.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script async src="https://platform.x.com/widgets.js" charset="utf-8"></script>
</body>